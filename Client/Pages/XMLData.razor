@page "/xmldata"
@using DominosCutScreen.Shared
@using System.Xml.Serialization;
@using System.Text.Json;
@using System.Text.Json.Serialization;
@using System.Globalization;
@using System.Diagnostics.CodeAnalysis;
@implements IDisposable
@inject Blazored.LocalStorage.ILocalStorageService localStorage
@inject HttpClient Http

<PageTitle>XML Data</PageTitle>

<div class="my-1">
    <button @onclick="@(async e => { showAllOrders = true; await InvokeAsync(StateHasChanged); })">Show All Orders</button>
    <button @onclick="@(async e => { showAllOrders = false; await InvokeAsync(StateHasChanged); })">Trim Orders</button>
</div>

@{
    var processedHistory = BumpHistory.GroupBy(h => h.OrderNumber)
                                    .Select(g => new
                                    {
                                        OrderNumber = g.Key,
                                        LastBumpedAt = g.Max(h => h.BumpedAtTime),
                                        Items = g.OrderBy(h => h.BumpedAtTime)
                                            .GroupBySequential(h => new { h.Description, h.ToppingModifications }, h => h, (x, y) => x.Description.Equals(y.Description, StringComparison.InvariantCultureIgnoreCase) && Enumerable.SequenceEqual(x.ToppingModifications, y.ToppingModifications))
                                            .Select(g => new
                                            {
                                                Item = g.First(),
                                                Quantity = g.Count()
                                            })
                                    })
                                    .OrderByDescending(x => x.LastBumpedAt);

    <div class="d-flex flex-row">
    @foreach (var order in processedHistory.Where(x => showAllOrders ? true : (DateTime.Now - x.LastBumpedAt) <= TimeSpan.FromSeconds(OvenTime + GraceTime)))
    {
        <div class="card mx-2" style="width: 18rem;">
            <div class="card-body">
                    <h5 class="card-title">Order @order.OrderNumber | @order.LastBumpedAt.ToString("T")</h5>
                @foreach (var item in order.Items)
                {
                    //Console.WriteLine(JsonSerializer.Serialize(bumpedItem));
                        <p class="card-text m-0">
                            @(item.Quantity)x @item.Item.Description

                    @foreach (var tm in item.Item.ToppingModifications.OrderBy(t => t.DisplaySequence))
                    {
                        var color = tm.ToppingAmountCode == 45 ? "danger" : "success";

                        <br />
                        <span class="d-inline-block text-@color" style="text-indent: 1rem;">@tm.ToppingAmountDescription @tm.ToppingDescription</span>
                    }

                    </p>
                }
            </div>
            <div class="card-footer text-center">
            @{/*
                <small class="text-muted">@(item.Order.IsElectronic ? "Internet" : CultureInfo.CurrentCulture.TextInfo.ToTitleCase(item.Order.TakenBy.ToLower()))</small>
                */}
            </div>
        </div>
    }
    </div>
}

@code {
    private System.Timers.Timer FetchTimer = new ();
    private List<MakeLineOrderItemHistory> BumpHistory = new();
    private bool showAllOrders = false;

    /// <summary>
    /// How long is the oven time in seconds
    /// </summary>
    private const int OvenTime = 300;

    /// <summary>
    /// How long should orders stay on the screen once they have been bumped for <see cref="OvenTime">
    /// </summary>
    private const int GraceTime = 30;

    protected override async Task OnInitializedAsync()
    {
        await GetData();

        FetchTimer.AutoReset = true;
        FetchTimer.Interval = 5000;
        FetchTimer.Elapsed += async (object? sender, System.Timers.ElapsedEventArgs e) =>
        {
            await GetData();
        };
        FetchTimer.Start();
    }

    protected async Task GetData()
    {
        var newData = await Http.GetFromJsonAsync<IEnumerable<MakeLineOrderItemHistory>>("api/Makeline/bump");

        if (newData == null)
            return;

        BumpHistory.AddRange(newData);
        BumpHistory = BumpHistory.Distinct().ToList();

        await InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        FetchTimer?.Dispose();
    }


}
